<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Calculator</title>
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0a0f1c;
            --bg-secondary: #111827;
            --bg-card: #1a2235;
            --accent: #f59e0b;
            --accent-light: #fbbf24;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #2d3a52;
            --success: #10b981;
            --danger: #ef4444;
            --info: #3b82f6;
            --purple: #8b5cf6;
            --pink: #ec4899;
            --cyan: #06b6d4;
            --gradient-1: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(245, 158, 11, 0.15) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 50px;
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .disclaimer-note {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 12px 20px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 10px;
            font-size: 0.85rem;
            color: var(--accent-light);
            max-width: 700px;
            text-align: left;
            line-height: 1.5;
        }

        .disclaimer-note svg {
            flex-shrink: 0;
            color: var(--accent);
        }

        .user-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .user-selector label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .user-select-wrapper {
            position: relative;
            min-width: 200px;
        }

        .user-select-wrapper select {
            width: 100%;
            padding: 10px 40px 10px 15px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            cursor: pointer;
            appearance: none;
            transition: all 0.2s ease;
        }

        .user-select-wrapper select:hover {
            border-color: var(--accent);
        }

        .user-select-wrapper select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }

        .user-select-wrapper::after {
            content: '';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            border-top-color: var(--text-muted);
            pointer-events: none;
        }

        .user-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .user-btn-new {
            background: var(--gradient-1);
            color: var(--bg-primary);
        }

        .user-btn-new:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .user-btn-delete {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .user-btn-delete:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        .user-btn-rename {
            background: rgba(59, 130, 246, 0.15);
            color: var(--info);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .user-btn-rename:hover {
            background: rgba(59, 130, 246, 0.25);
        }

        .current-user-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 6px 14px;
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--purple);
        }

        .current-user-badge svg {
            width: 14px;
            height: 14px;
        }

        .save-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 15px;
            padding: 8px 16px;
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--success);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .save-indicator.visible {
            opacity: 1;
        }

        .save-indicator svg {
            width: 16px;
            height: 16px;
        }

        .calculator-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        .calculator-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-1);
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .section-title svg {
            width: 24px;
            height: 24px;
            color: var(--accent);
        }

        .section-title .total-badge {
            margin-left: auto;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 6px 14px;
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 20px;
            color: var(--purple);
        }

        .section-description {
            color: var(--text-muted);
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .form-grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        }

        .form-grid-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        @media (max-width: 900px) {
            .form-grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 500px) {
            .form-grid-4 {
                grid-template-columns: 1fr;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 12px;
        }

        .label-hint {
            display: block;
            font-size: 0.7rem;
            font-weight: 400;
            color: var(--text-muted);
            text-transform: none;
            letter-spacing: normal;
            margin-top: 4px;
        }

        .input-wrapper {
            position: relative;
        }

        .input-prefix,
        .input-suffix {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-weight: 500;
            font-size: 1rem;
            pointer-events: none;
        }

        .input-prefix {
            left: 20px;
        }

        .input-suffix {
            right: 20px;
        }

        .input-calc-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            background: var(--gradient-1);
            color: var(--bg-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            pointer-events: auto;
            z-index: 10;
        }

        .input-calc-btn:hover {
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        .input-calc-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        .has-prefix.has-suffix input {
            padding-right: 55px;
        }

        .has-prefix.has-suffix .input-prefix {
            pointer-events: none;
        }

        input,
        select {
            width: 100%;
            padding: 18px 20px;
            font-size: 1.1rem;
            font-family: 'DM Sans', sans-serif;
            font-weight: 500;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 20px;
            padding-right: 50px;
        }

        select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.15);
        }

        input::placeholder {
            color: var(--text-muted);
        }

        .input-wrapper.has-prefix input {
            padding-left: 40px;
        }

        .input-wrapper.has-suffix input {
            padding-right: 50px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 18px 40px;
            font-size: 1rem;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            background: var(--gradient-1);
            color: var(--bg-primary);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px -10px rgba(245, 158, 11, 0.5);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px -10px rgba(245, 158, 11, 0.6);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn svg {
            width: 20px;
            height: 20px;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            box-shadow: none;
            border: 2px solid var(--border);
            padding: 12px 24px;
            font-size: 0.9rem;
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            box-shadow: none;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            box-shadow: none;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 8px 16px;
            font-size: 0.8rem;
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.25);
            box-shadow: none;
        }

        .btn-clear {
            background: transparent;
            color: var(--text-muted);
            box-shadow: none;
            border: 1px solid var(--border);
            padding: 12px 24px;
            font-size: 0.85rem;
        }

        .btn-clear:hover {
            border-color: var(--danger);
            color: var(--danger);
            box-shadow: none;
        }

        .btn-pdf {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 10px 30px -10px rgba(239, 68, 68, 0.5);
        }

        .btn-pdf:hover {
            box-shadow: 0 15px 40px -10px rgba(239, 68, 68, 0.6);
        }

        .dynamic-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid var(--border);
        }

        .entries-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .entry-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .entry-row .form-group {
            margin-bottom: 0;
        }

        .entry-row label {
            margin-bottom: 8px;
            font-size: 0.75rem;
        }

        .entry-row input {
            padding: 14px 16px;
            font-size: 1rem;
        }

        .entry-row .input-wrapper.has-prefix input {
            padding-left: 35px;
        }

        .entry-row .input-wrapper.has-suffix input {
            padding-right: 45px;
        }

        .entry-row .input-prefix {
            left: 16px;
            font-size: 0.9rem;
        }

        .entry-row .input-suffix {
            right: 16px;
            font-size: 0.9rem;
        }

        .no-entries {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
            font-style: italic;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px dashed var(--border);
        }

        .add-btn-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .results-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .results-section.visible {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card.highlight {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.05) 100%);
        }

        .summary-card.purple {
            border-color: var(--purple);
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%);
        }

        .summary-card.success {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
        }

        .summary-card.info {
            border-color: var(--info);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
        }

        .summary-card.cyan {
            border-color: var(--cyan);
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(6, 182, 212, 0.05) 100%);
        }

        .summary-card.pink {
            border-color: var(--pink);
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.1) 0%, rgba(236, 72, 153, 0.05) 100%);
        }

        .summary-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 8px;
        }

        .summary-value {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .summary-card.highlight .summary-value {
            color: var(--accent);
        }

        .summary-card.purple .summary-value {
            color: var(--purple);
        }

        .summary-card.success .summary-value {
            color: var(--success);
        }

        .summary-card.info .summary-value {
            color: var(--info);
        }

        .summary-card.cyan .summary-value {
            color: var(--cyan);
        }

        .summary-card.pink .summary-value {
            color: var(--pink);
        }

        .term-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .term-section h3 {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .term-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .term-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .term-card .term-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--border);
            color: var(--text-muted);
            font-size: 10px;
            font-weight: bold;
            cursor: help;
            position: relative;
            font-style: normal;
            transition: all 0.2s ease;
        }

        .info-icon:hover {
            background: var(--primary);
            color: var(--bg-primary);
        }

        .info-tooltip {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 14px;
            width: 220px;
            font-size: 11px;
            font-weight: 400;
            text-transform: none;
            letter-spacing: normal;
            line-height: 1.5;
            color: var(--text-secondary);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 100;
            text-align: left;
        }

        .info-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--border);
        }

        .info-icon:hover .info-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .term-card .term-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'Playfair Display', serif;
        }

        .term-card .term-sub {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .term-card.total .term-value {
            color: var(--purple);
        }

        .term-card.completed .term-value {
            color: var(--success);
        }

        .term-card.remaining .term-value {
            color: var(--info);
        }

        .term-card.saved .term-value {
            color: var(--pink);
        }

        .progress-container {
            margin-top: 20px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .progress-bar {
            height: 24px;
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-fill.completed {
            background: linear-gradient(90deg, var(--success) 0%, #059669 100%);
        }

        .progress-fill.remaining {
            background: linear-gradient(90deg, var(--info) 0%, #2563eb 100%);
            position: absolute;
            top: 0;
        }

        .progress-text {
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .charts-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .charts-section h3 {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        .chart-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
        }

        .chart-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 15px;
            text-align: center;
        }

        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3);
        }

        .table-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 30px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .table-header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .table-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--success);
        }

        .table-wrapper {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            padding: 14px 10px;
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            text-align: right;
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }

        th:first-child {
            text-align: center;
        }

        th:nth-child(2) {
            text-align: left;
        }

        td {
            padding: 12px 10px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: right;
            border-bottom: 1px solid rgba(45, 58, 82, 0.5);
            font-variant-numeric: tabular-nums;
        }

        td:first-child {
            text-align: center;
            font-weight: 600;
            color: var(--text-muted);
        }

        td:nth-child(2) {
            text-align: left;
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        tr:hover td {
            background: rgba(245, 158, 11, 0.03);
        }

        tr:last-child td {
            border-bottom: none;
            background: rgba(16, 185, 129, 0.05);
            color: var(--success);
            font-weight: 600;
        }

        tr.rate-change-row td {
            background: rgba(59, 130, 246, 0.08);
            border-top: 2px solid var(--info);
        }

        tr.part-payment-row td {
            background: rgba(16, 185, 129, 0.08);
            border-top: 2px solid var(--success);
        }

        tr.disbursement-row td {
            background: rgba(139, 92, 246, 0.08);
            border-top: 2px solid var(--purple);
        }

        tr.emi-change-row td {
            background: rgba(236, 72, 153, 0.08);
            border-top: 2px solid var(--pink);
        }

        .amount-principal {
            color: var(--accent-light);
            font-weight: 500;
        }

        .zero-remaining {
            color: var(--success) !important;
        }

        .rate-badge,
        .part-payment-badge,
        .disbursement-badge,
        .emi-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.6rem;
            margin-left: 4px;
        }

        .rate-badge {
            background: rgba(59, 130, 246, 0.2);
            color: var(--info);
        }

        .part-payment-badge {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .disbursement-badge {
            background: rgba(139, 92, 246, 0.2);
            color: var(--purple);
        }

        .emi-badge {
            background: rgba(236, 72, 153, 0.2);
            color: var(--pink);
        }

        .event-indicator {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .calculator-card {
                padding: 24px;
            }

            .form-grid {
                gap: 20px;
            }

            .entry-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            th,
            td {
                padding: 8px 5px;
                font-size: 0.65rem;
            }

            .add-btn-container {
                flex-direction: column;
            }

            .btn-secondary {
                width: 100%;
            }

            .summary-value {
                font-size: 1.2rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-buttons .btn {
                width: 100%;
            }

            .table-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .table-header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .term-card .term-value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Loan Calculator</h1>
            <p class="subtitle">Calculate your monthly payments with disbursements, EMI changes, part payments and
                interest rate changes</p>

            <div class="disclaimer-note">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <span><strong>Disclaimer:</strong> This calculator is for <strong>educational purposes only</strong>.
                    Results are approximate and should not be considered as financial advice. Please consult your bank
                    or financial advisor for accurate loan calculations.</span>
            </div>

            <div class="user-selector">
                <label>ðŸ‘¤ User Profile:</label>
                <div class="user-select-wrapper">
                    <select id="userSelect" onchange="switchUser()">
                        <option value="">-- Select User --</option>
                    </select>
                </div>
                <button class="user-btn user-btn-new" onclick="createNewUser()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    New User
                </button>
                <button class="user-btn user-btn-rename" onclick="renameCurrentUser()" id="renameUserBtn"
                    style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    Rename
                </button>
                <button class="user-btn user-btn-delete" onclick="deleteCurrentUser()" id="deleteUserBtn"
                    style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                </button>
            </div>

            <div class="current-user-badge" id="currentUserBadge" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <span id="currentUserName">No user selected</span>
            </div>

            <div class="save-indicator" id="saveIndicator">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                Data saved automatically
            </div>
        </header>
        <div class="calculator-card">
            <h3 class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Loan Disbursements
                <span class="total-badge" id="totalDisbursement">Total: â‚¹0</span>
            </h3>
            <p class="section-description">Add loan amounts as they are disbursed on different dates.</p>
            <div class="entries-container" id="disbursementsContainer">
                <div class="no-entries">No disbursements added. Click "Add Disbursement" to add loan amount.</div>
            </div>
            <div class="add-btn-container">
                <button class="btn btn-secondary" onclick="addDisbursement()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        width="18" height="18">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    Add Disbursement
                </button>
            </div>
            <div class="dynamic-section">
                <h3 class="section-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Initial Loan Settings
                </h3>
                <div class="form-grid form-grid-4">
                    <div class="form-group">
                        <label>Initial Interest Rate (Annual)</label>
                        <div class="input-wrapper has-suffix">
                            <input type="number" id="interestRate" placeholder="12" step="0.1" min="0.1" max="50"
                                oninput="autoCalculateEMI(); saveData()">
                            <span class="input-suffix">%</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Original Loan Term<span class="label-hint">Bank sanctioned term (in years)</span></label>
                        <div class="input-wrapper has-suffix">
                            <input type="number" id="originalTerm" placeholder="20" step="1" min="1" max="40"
                                oninput="autoCalculateEMI(); saveData()">
                            <span class="input-suffix">Years</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Initial Monthly EMI<span class="label-hint" id="emiAutoLabel"
                                style="color: var(--success);">Auto-calculated</span></label>
                        <div class="input-wrapper has-prefix has-suffix">
                            <span class="input-prefix">â‚¹</span>
                            <input type="number" id="emiPayment" placeholder="Auto" min="100" oninput="saveData()">
                            <button type="button" class="input-calc-btn" onclick="recalculateEMIWithFeedback()"
                                title="Recalculate EMI">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>EMI Deduction Day<span class="label-hint">Day of month when EMI is
                                deducted</span></label>
                        <select id="emiDeductionDay" onchange="saveData()">
                            <option value="1">1st of every month</option>
                            <option value="5">5th of every month</option>
                            <option value="7">7th of every month</option>
                            <option value="10">10th of every month</option>
                            <option value="15">15th of every month</option>
                            <option value="20">20th of every month</option>
                            <option value="25">25th of every month</option>
                            <option value="28">28th of every month</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="dynamic-section">
                <h3 class="section-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                    </svg>
                    EMI Changes
                </h3>
                <p class="section-description">Change your monthly EMI amount on specific dates.</p>
                <div class="entries-container" id="emiChangesContainer">
                    <div class="no-entries">No EMI changes added.</div>
                </div>
                <div class="add-btn-container">
                    <button class="btn btn-secondary" onclick="addEmiChange()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            width="18" height="18">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Add EMI Change
                    </button>
                </div>
            </div>
            <div class="dynamic-section">
                <h3 class="section-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    Part Payments (Extra Payments)
                </h3>
                <p class="section-description">Add one-time extra payments to reduce principal faster.</p>
                <div class="entries-container" id="partPaymentsContainer">
                    <div class="no-entries">No part payments added.</div>
                </div>
                <div class="add-btn-container">
                    <button class="btn btn-secondary" onclick="addPartPayment()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            width="18" height="18">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Add Part Payment
                    </button>
                </div>
            </div>
            <div class="dynamic-section">
                <h3 class="section-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                    </svg>
                    Interest Rate Changes
                </h3>
                <p class="section-description">Add interest rate changes when your bank revises the rate.</p>
                <div class="entries-container" id="rateChangesContainer">
                    <div class="no-entries">No rate changes added.</div>
                </div>
                <div class="add-btn-container">
                    <button class="btn btn-secondary" onclick="addRateChange()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            width="18" height="18">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        Add Rate Change
                    </button>
                </div>
            </div>
            <div style="margin-top: 40px;">
                <div class="action-buttons">
                    <button class="btn" onclick="calculateLoan()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                        Calculate
                    </button>
                    <button class="btn btn-clear" onclick="clearAllData()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            width="18" height="18">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        Clear All Data
                    </button>
                </div>
            </div>
        </div>
        <div class="results-section" id="resultsSection">
            <div class="summary-cards">
                <div class="summary-card purple">
                    <div class="summary-label">Total Disbursed</div>
                    <div class="summary-value" id="summaryDisbursed">â‚¹0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Total Principal</div>
                    <div class="summary-value" id="totalPrincipal">â‚¹0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Total Interest</div>
                    <div class="summary-value" id="totalInterest">â‚¹0</div>
                </div>
                <div class="summary-card highlight">
                    <div class="summary-label">Total Amount Paid</div>
                    <div class="summary-value" id="totalAmount">â‚¹0</div>
                </div>
                <div class="summary-card success">
                    <div class="summary-label">Interest Saved</div>
                    <div class="summary-value" id="interestSaved">â‚¹0</div>
                </div>
            </div>
            <div class="term-section">
                <h3>ðŸ“… Loan Term Analysis</h3>
                <div class="term-grid">
                    <div class="term-card" style="border: 1px solid var(--border);">
                        <div class="term-label">
                            Original Bank Term
                            <i class="info-icon">i<span class="info-tooltip">The loan tenure you originally agreed with
                                    the bank when taking the loan. Enter this in the "Original Loan Term" field
                                    above.</span></i>
                        </div>
                        <div class="term-value" id="originalTermMonths" style="color: var(--text-muted);">0</div>
                        <div class="term-sub" id="originalTermYears">0 years</div>
                    </div>
                    <div class="term-card total">
                        <div class="term-label">
                            Actual Loan Term
                            <i class="info-icon">i<span class="info-tooltip">The calculated number of months to fully
                                    repay the loan based on your EMI, interest rate, part payments, and disbursements.
                                    This may differ from the original term.</span></i>
                        </div>
                        <div class="term-value" id="totalTermMonths">0</div>
                        <div class="term-sub" id="totalTermYears">0 years 0 months</div>
                    </div>
                    <div class="term-card completed">
                        <div class="term-label">
                            Completed Term
                            <i class="info-icon">i<span class="info-tooltip">Number of EMI payments already made from
                                    the loan start date until today. This shows how much of your loan journey is
                                    complete.</span></i>
                        </div>
                        <div class="term-value" id="completedTermMonths">0</div>
                        <div class="term-sub" id="completedTermYears">0 years 0 months</div>
                    </div>
                    <div class="term-card remaining">
                        <div class="term-label">
                            Remaining Term
                            <i class="info-icon">i<span class="info-tooltip">Number of EMI payments left to fully close
                                    the loan. Calculated as: Actual Loan Term - Completed Term.</span></i>
                        </div>
                        <div class="term-value" id="remainingTermMonths">0</div>
                        <div class="term-sub" id="remainingTermYears">0 years 0 months</div>
                    </div>
                    <div class="term-card saved">
                        <div class="term-label">
                            Term Saved (vs Original)
                            <i class="info-icon">i<span class="info-tooltip">Months saved compared to original bank term
                                    due to part payments and higher EMI. Calculated as: Original Term - Actual Term.
                                    More savings = less interest paid!</span></i>
                        </div>
                        <div class="term-value" id="savedTermMonths">0</div>
                        <div class="term-sub" id="savedTermYears">0 years 0 months</div>
                    </div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Loan Progress (Based on Actual Term)</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill completed" id="progressFill" style="width: 0%">
                            <span class="progress-text" id="progressText"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="charts-section">
                <h3>ðŸ“Š Loan Analytics</h3>
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-title">Payment Breakdown</div>
                        <canvas id="pieChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Balance Over Time (Year-wise)</div>
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="table-container">
                <div class="table-header">
                    <h2 class="table-title">Amortization Schedule</h2>
                    <div class="table-header-actions">
                        <span class="table-badge" id="statusBadge">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="3">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            Loan Closed
                        </span>
                        <button class="btn btn-pdf" onclick="exportPDF()"
                            style="padding: 10px 20px; font-size: 0.85rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" width="18" height="18">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Export PDF
                        </button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>EMI Date</th>
                                <th>Rate</th>
                                <th>EMI</th>
                                <th>Disbursement</th>
                                <th>Principal</th>
                                <th>Interest</th>
                                <th>Part Pay</th>
                                <th>Total</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
        const USERS_KEY = 'loanCalculatorUsers';
        const CURRENT_USER_KEY = 'loanCalculatorCurrentUser';
        let currentUserId = null;
        let disbursementCounter = 0, emiChangeCounter = 0, partPaymentCounter = 0, rateChangeCounter = 0;
        let saveTimeout = null, calculatedSchedule = [], calculatedSummary = {};
        let pieChart = null, lineChart = null;

        // User Management Functions
        function getAllUsers() {
            const users = localStorage.getItem(USERS_KEY);
            return users ? JSON.parse(users) : {};
        }

        function saveAllUsers(users) {
            localStorage.setItem(USERS_KEY, JSON.stringify(users));
        }

        function populateUserDropdown() {
            const select = document.getElementById('userSelect');
            const users = getAllUsers();
            const userIds = Object.keys(users);

            select.innerHTML = '<option value="">-- Select User --</option>';

            userIds.sort((a, b) => users[a].name.localeCompare(users[b].name));

            userIds.forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = users[id].name;
                if (id === currentUserId) option.selected = true;
                select.appendChild(option);
            });

            // Show/hide action buttons based on selection
            const hasUser = currentUserId && users[currentUserId];
            document.getElementById('deleteUserBtn').style.display = hasUser ? 'inline-flex' : 'none';
            document.getElementById('renameUserBtn').style.display = hasUser ? 'inline-flex' : 'none';

            // Update current user badge
            const badge = document.getElementById('currentUserBadge');
            const nameSpan = document.getElementById('currentUserName');
            if (hasUser) {
                badge.style.display = 'inline-flex';
                nameSpan.textContent = users[currentUserId].name;
            } else {
                badge.style.display = 'none';
            }
        }

        function createNewUser() {
            const name = prompt('Enter new user name:');
            if (!name || !name.trim()) return;

            const users = getAllUsers();
            const userId = 'user_' + Date.now();

            users[userId] = {
                name: name.trim(),
                data: null,
                createdAt: new Date().toISOString()
            };

            saveAllUsers(users);
            currentUserId = userId;
            localStorage.setItem(CURRENT_USER_KEY, userId);

            clearFormData();
            populateUserDropdown();
            addDisbursement();

            alert(`User "${name.trim()}" created successfully!`);
        }

        function switchUser() {
            const select = document.getElementById('userSelect');
            const userId = select.value;

            if (!userId) {
                currentUserId = null;
                localStorage.removeItem(CURRENT_USER_KEY);
                clearFormData();
                populateUserDropdown();
                addDisbursement();
                return;
            }

            currentUserId = userId;
            localStorage.setItem(CURRENT_USER_KEY, userId);

            loadUserData();
            populateUserDropdown();
        }

        function renameCurrentUser() {
            if (!currentUserId) return;

            const users = getAllUsers();
            if (!users[currentUserId]) return;

            const currentName = users[currentUserId].name;
            const newName = prompt('Enter new name:', currentName);

            if (!newName || !newName.trim() || newName.trim() === currentName) return;

            users[currentUserId].name = newName.trim();
            saveAllUsers(users);
            populateUserDropdown();

            alert(`User renamed to "${newName.trim()}" successfully!`);
        }

        function deleteCurrentUser() {
            if (!currentUserId) return;

            const users = getAllUsers();
            if (!users[currentUserId]) return;

            const userName = users[currentUserId].name;
            if (!confirm(`Are you sure you want to delete user "${userName}" and all their data?`)) return;

            delete users[currentUserId];
            saveAllUsers(users);

            currentUserId = null;
            localStorage.removeItem(CURRENT_USER_KEY);

            clearFormData();
            populateUserDropdown();
            addDisbursement();

            alert(`User "${userName}" deleted successfully!`);
        }

        function clearFormData() {
            document.getElementById('interestRate').value = '';
            document.getElementById('emiPayment').value = '';
            document.getElementById('emiDeductionDay').value = '1';
            document.getElementById('originalTerm').value = '';
            document.getElementById('disbursementsContainer').innerHTML = '';
            document.getElementById('emiChangesContainer').innerHTML = '';
            document.getElementById('partPaymentsContainer').innerHTML = '';
            document.getElementById('rateChangesContainer').innerHTML = '';
            document.getElementById('totalDisbursement').textContent = 'Total: â‚¹0';
            document.getElementById('resultsSection').classList.remove('visible');

            disbursementCounter = 0;
            emiChangeCounter = 0;
            partPaymentCounter = 0;
            rateChangeCounter = 0;
            calculatedSchedule = [];
            calculatedSummary = {};
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('visible');
            setTimeout(() => indicator.classList.remove('visible'), 2000);
        }

        function saveData() {
            if (!currentUserId) return; // Don't save if no user selected

            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                const data = {
                    interestRate: document.getElementById('interestRate').value,
                    emiPayment: document.getElementById('emiPayment').value,
                    emiDeductionDay: document.getElementById('emiDeductionDay').value,
                    originalTerm: document.getElementById('originalTerm').value,
                    disbursements: [], emiChanges: [], partPayments: [], rateChanges: []
                };
                document.querySelectorAll('#disbursementsContainer .entry-row').forEach(row => {
                    data.disbursements.push({ date: row.querySelector('.disbursement-date').value, amount: row.querySelector('.disbursement-amount').value });
                });
                document.querySelectorAll('#emiChangesContainer .entry-row').forEach(row => {
                    data.emiChanges.push({ date: row.querySelector('.emi-change-date').value, amount: row.querySelector('.emi-change-amount').value });
                });
                document.querySelectorAll('#partPaymentsContainer .entry-row').forEach(row => {
                    data.partPayments.push({ date: row.querySelector('.part-payment-date').value, amount: row.querySelector('.part-payment-amount').value });
                });
                document.querySelectorAll('#rateChangesContainer .entry-row').forEach(row => {
                    data.rateChanges.push({ date: row.querySelector('.rate-change-date').value, rate: row.querySelector('.rate-change-rate').value });
                });

                const users = getAllUsers();
                if (users[currentUserId]) {
                    users[currentUserId].data = data;
                    users[currentUserId].updatedAt = new Date().toISOString();
                    saveAllUsers(users);
                    showSaveIndicator();
                }
            }, 500);
        }

        function loadUserData() {
            clearFormData();

            if (!currentUserId) {
                addDisbursement();
                return;
            }

            const users = getAllUsers();
            const user = users[currentUserId];

            if (!user || !user.data) {
                addDisbursement();
                return;
            }

            const data = user.data;

            try {
                if (data.interestRate) document.getElementById('interestRate').value = data.interestRate;
                if (data.emiPayment) document.getElementById('emiPayment').value = data.emiPayment;
                if (data.emiDeductionDay) document.getElementById('emiDeductionDay').value = data.emiDeductionDay;
                if (data.originalTerm) document.getElementById('originalTerm').value = data.originalTerm;
                if (data.disbursements?.length > 0) data.disbursements.forEach(d => addDisbursement(d.date, d.amount, false));
                else addDisbursement();
                if (data.emiChanges?.length > 0) data.emiChanges.forEach(e => addEmiChange(e.date, e.amount, false));
                if (data.partPayments?.length > 0) data.partPayments.forEach(p => addPartPayment(p.date, p.amount, false));
                if (data.rateChanges?.length > 0) data.rateChanges.forEach(r => addRateChange(r.date, r.rate, false));
                updateTotalDisbursement();
            } catch (e) {
                console.error('Error loading user data:', e);
                addDisbursement();
            }
        }

        function loadData() {
            // Load saved current user
            const savedUserId = localStorage.getItem(CURRENT_USER_KEY);
            const users = getAllUsers();

            if (savedUserId && users[savedUserId]) {
                currentUserId = savedUserId;
            }

            populateUserDropdown();

            if (currentUserId) {
                loadUserData();
            } else {
                addDisbursement();
            }
        }

        function clearAllData() {
            if (!currentUserId) {
                alert('Please select a user first.');
                return;
            }
            if (confirm('Are you sure you want to clear all data for this user?')) {
                const users = getAllUsers();
                if (users[currentUserId]) {
                    users[currentUserId].data = null;
                    saveAllUsers(users);
                }
                clearFormData();
                addDisbursement();
            }
        }

        function updateTotalDisbursement() {
            let total = 0;
            document.querySelectorAll('#disbursementsContainer .disbursement-amount').forEach(input => { total += parseFloat(input.value) || 0; });
            document.getElementById('totalDisbursement').textContent = `Total: ${formatCurrency(total)}`;
            autoCalculateEMI();
        }

        function recalculateEMIWithFeedback() {
            const btn = document.querySelector('.input-calc-btn');
            const svg = btn.querySelector('svg');

            // Add spinning animation
            svg.style.transition = 'transform 0.3s ease';
            svg.style.transform = 'rotate(360deg)';

            // Force recalculate
            autoCalculateEMI(true);

            // Reset rotation after animation
            setTimeout(() => {
                svg.style.transform = 'rotate(0deg)';
            }, 300);

            // Show feedback
            const emiLabel = document.getElementById('emiAutoLabel');
            if (emiLabel) {
                emiLabel.style.display = 'inline';
                emiLabel.textContent = 'âœ“ Recalculated!';
                emiLabel.style.color = 'var(--success)';
                setTimeout(() => {
                    emiLabel.textContent = 'Auto-calculated';
                }, 1500);
            }
        }

        function autoCalculateEMI(forceCalculate = false) {
            const interestRate = parseFloat(document.getElementById('interestRate').value);
            const originalTerm = parseFloat(document.getElementById('originalTerm').value);
            const emiInput = document.getElementById('emiPayment');
            const emiLabel = document.getElementById('emiAutoLabel');

            // Get total disbursement amount
            let principal = 0;
            document.querySelectorAll('#disbursementsContainer .disbursement-amount').forEach(input => {
                principal += parseFloat(input.value) || 0;
            });

            // Check if we have all required values
            if (!principal || !interestRate || !originalTerm) {
                if (emiLabel) emiLabel.style.display = 'none';
                return;
            }

            // Only auto-calculate if EMI is empty or force calculate is true
            if (!forceCalculate && emiInput.value && emiInput.value !== '') {
                if (emiLabel) emiLabel.style.display = 'none';
                return;
            }

            // EMI Formula: P Ã— r Ã— (1 + r)^n / ((1 + r)^n - 1)
            // Where: P = Principal, r = monthly interest rate, n = number of months
            const monthlyRate = interestRate / 12 / 100;
            const numberOfMonths = originalTerm * 12;

            let emi;
            if (monthlyRate === 0) {
                emi = principal / numberOfMonths;
            } else {
                const factor = Math.pow(1 + monthlyRate, numberOfMonths);
                emi = principal * monthlyRate * factor / (factor - 1);
            }

            // Round to nearest integer
            emi = Math.round(emi);

            if (emi > 0 && isFinite(emi)) {
                emiInput.value = emi;
                if (emiLabel) {
                    emiLabel.style.display = 'inline';
                    emiLabel.textContent = 'Auto-calculated';
                }
                saveData();
            }
        }

        function addDisbursement(date = null, amount = null, save = true) {
            disbursementCounter++;
            const container = document.getElementById('disbursementsContainer');
            const noEntries = container.querySelector('.no-entries');
            if (noEntries) noEntries.remove();
            const today = date || new Date().toISOString().split('T')[0];
            const amountValue = amount || '';
            container.insertAdjacentHTML('beforeend', `
        <div class="entry-row" id="disbursement-${disbursementCounter}">
          <div class="form-group"><label>Disbursement Date</label><input type="date" class="disbursement-date" value="${today}" onchange="saveData()"></div>
          <div class="form-group"><label>Disbursement Amount</label><div class="input-wrapper has-prefix"><span class="input-prefix">â‚¹</span><input type="number" class="disbursement-amount" placeholder="500000" min="1" value="${amountValue}" oninput="updateTotalDisbursement(); autoCalculateEMI(); saveData()"></div></div>
          <button class="btn btn-danger" onclick="removeEntry('disbursement-${disbursementCounter}', 'disbursementsContainer', true)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>Remove</button>
        </div>`);
            updateTotalDisbursement();
            if (save) saveData();
        }

        function addEmiChange(date = null, amount = null, save = true) {
            emiChangeCounter++;
            const container = document.getElementById('emiChangesContainer');
            const noEntries = container.querySelector('.no-entries');
            if (noEntries) noEntries.remove();
            container.insertAdjacentHTML('beforeend', `
        <div class="entry-row" id="emiChange-${emiChangeCounter}">
          <div class="form-group"><label>Effective Date</label><input type="date" class="emi-change-date" value="${date || ''}" onchange="saveData()"></div>
          <div class="form-group"><label>New EMI Amount</label><div class="input-wrapper has-prefix"><span class="input-prefix">â‚¹</span><input type="number" class="emi-change-amount" placeholder="20000" min="100" value="${amount || ''}" oninput="saveData()"></div></div>
          <button class="btn btn-danger" onclick="removeEntry('emiChange-${emiChangeCounter}', 'emiChangesContainer')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>Remove</button>
        </div>`);
            if (save) saveData();
        }

        function addPartPayment(date = null, amount = null, save = true) {
            partPaymentCounter++;
            const container = document.getElementById('partPaymentsContainer');
            const noEntries = container.querySelector('.no-entries');
            if (noEntries) noEntries.remove();
            container.insertAdjacentHTML('beforeend', `
        <div class="entry-row" id="partPayment-${partPaymentCounter}">
          <div class="form-group"><label>Payment Date</label><input type="date" class="part-payment-date" value="${date || ''}" onchange="saveData()"></div>
          <div class="form-group"><label>Part Payment Amount</label><div class="input-wrapper has-prefix"><span class="input-prefix">â‚¹</span><input type="number" class="part-payment-amount" placeholder="50000" min="1" value="${amount || ''}" oninput="saveData()"></div></div>
          <button class="btn btn-danger" onclick="removeEntry('partPayment-${partPaymentCounter}', 'partPaymentsContainer')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>Remove</button>
        </div>`);
            if (save) saveData();
        }

        function addRateChange(date = null, rate = null, save = true) {
            rateChangeCounter++;
            const container = document.getElementById('rateChangesContainer');
            const noEntries = container.querySelector('.no-entries');
            if (noEntries) noEntries.remove();
            container.insertAdjacentHTML('beforeend', `
        <div class="entry-row" id="rateChange-${rateChangeCounter}">
          <div class="form-group"><label>Effective Date</label><input type="date" class="rate-change-date" value="${date || ''}" onchange="saveData()"></div>
          <div class="form-group"><label>New Interest Rate (Annual)</label><div class="input-wrapper has-suffix"><input type="number" class="rate-change-rate" placeholder="10.5" step="0.1" min="0.1" max="50" value="${rate || ''}" oninput="saveData()"><span class="input-suffix">%</span></div></div>
          <button class="btn btn-danger" onclick="removeEntry('rateChange-${rateChangeCounter}', 'rateChangesContainer')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>Remove</button>
        </div>`);
            if (save) saveData();
        }

        function removeEntry(entryId, containerId, updateDisbursement = false) {
            document.getElementById(entryId).remove();
            const container = document.getElementById(containerId);
            if (container.children.length === 0) {
                const messages = {
                    'disbursementsContainer': 'No disbursements added.',
                    'emiChangesContainer': 'No EMI changes added.',
                    'partPaymentsContainer': 'No part payments added.',
                    'rateChangesContainer': 'No rate changes added.'
                };
                container.innerHTML = `<div class="no-entries">${messages[containerId]}</div>`;
            }
            if (updateDisbursement) updateTotalDisbursement();
            saveData();
        }

        function formatCurrency(amount) { return 'â‚¹' + amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
        function formatCurrencyPlain(amount) { return amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
        function formatDate(date, day) { return new Date(date.getFullYear(), date.getMonth(), day).toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' }); }
        function formatDateShort(date) { return date.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' }); }
        function formatYearsMonths(months) { const y = Math.floor(months / 12); const m = months % 12; return y > 0 ? `${y} year${y > 1 ? 's' : ''} ${m} month${m !== 1 ? 's' : ''}` : `${m} month${m !== 1 ? 's' : ''}`; }

        function getDisbursements() {
            const disbursements = [];
            document.querySelectorAll('#disbursementsContainer .entry-row').forEach(row => {
                const date = row.querySelector('.disbursement-date').value;
                const amount = parseFloat(row.querySelector('.disbursement-amount').value);
                if (date && amount > 0) disbursements.push({ date: new Date(date), amount });
            });
            return disbursements.sort((a, b) => a.date - b.date);
        }
        function getEmiChanges() {
            const changes = [];
            document.querySelectorAll('#emiChangesContainer .entry-row').forEach(row => {
                const date = row.querySelector('.emi-change-date').value;
                const amount = parseFloat(row.querySelector('.emi-change-amount').value);
                if (date && amount > 0) changes.push({ date: new Date(date), amount });
            });
            return changes.sort((a, b) => a.date - b.date);
        }
        function getPartPayments() {
            const payments = [];
            document.querySelectorAll('#partPaymentsContainer .entry-row').forEach(row => {
                const date = row.querySelector('.part-payment-date').value;
                const amount = parseFloat(row.querySelector('.part-payment-amount').value);
                if (date && amount > 0) payments.push({ date: new Date(date), amount });
            });
            return payments.sort((a, b) => a.date - b.date);
        }
        function getRateChanges() {
            const changes = [];
            document.querySelectorAll('#rateChangesContainer .entry-row').forEach(row => {
                const date = row.querySelector('.rate-change-date').value;
                const rate = parseFloat(row.querySelector('.rate-change-rate').value);
                if (date && rate > 0) changes.push({ date: new Date(date), rate });
            });
            return changes.sort((a, b) => a.date - b.date);
        }

        function calculateLoanWithoutPartPayments(disbursements, initialRate, initialEMI, emiDeductionDay, emiChanges, rateChanges) {
            const disbursementMap = new Map();
            disbursements.forEach(d => {
                const key = `${d.date.getFullYear()}-${d.date.getMonth()}`;
                disbursementMap.set(key, (disbursementMap.get(key) || 0) + d.amount);
            });
            const emiChangeMap = new Map();
            emiChanges.forEach(ec => { emiChangeMap.set(`${ec.date.getFullYear()}-${ec.date.getMonth()}`, ec.amount); });
            const rateChangeMap = new Map();
            rateChanges.forEach(rc => { rateChangeMap.set(`${rc.date.getFullYear()}-${rc.date.getMonth()}`, rc.rate); });

            let balance = 0, currentRate = initialRate, currentEMI = initialEMI, month = 0;
            let currentDate = new Date(disbursements[0].date);
            currentDate.setDate(1);

            while ((balance > 0.01 || month === 0 || disbursementMap.size > 0) && month < 600) {
                month++;
                const monthKey = `${currentDate.getFullYear()}-${currentDate.getMonth()}`;
                const disbursementThisMonth = disbursementMap.get(monthKey) || 0;
                if (disbursementThisMonth > 0) { balance += disbursementThisMonth; disbursementMap.delete(monthKey); }
                if (emiChangeMap.has(monthKey)) currentEMI = emiChangeMap.get(monthKey);
                if (rateChangeMap.has(monthKey)) currentRate = rateChangeMap.get(monthKey);
                const monthlyRate = currentRate / 12 / 100;
                const interestForMonth = balance * monthlyRate;
                if (balance > 0) {
                    let emiPayment = currentEMI;
                    if (balance + interestForMonth <= emiPayment) emiPayment = balance + interestForMonth;
                    const principalForMonth = emiPayment - interestForMonth;
                    balance = Math.max(0, balance - principalForMonth);
                }
                currentDate.setMonth(currentDate.getMonth() + 1);
                if (balance < 0.01 && disbursementMap.size === 0) break;
            }
            return month;
        }

        function calculateLoan() {
            const initialRate = parseFloat(document.getElementById('interestRate').value);
            const initialEMI = parseFloat(document.getElementById('emiPayment').value);
            const emiDeductionDay = parseInt(document.getElementById('emiDeductionDay').value);
            const disbursements = getDisbursements();
            if (disbursements.length === 0) { alert('Please add at least one loan disbursement'); return; }
            if (!initialRate || !initialEMI) { alert('Please fill in interest rate and initial EMI payment'); return; }

            const startDate = disbursements[0].date;
            const emiChanges = getEmiChanges();
            const partPayments = getPartPayments();
            const rateChanges = getRateChanges();

            calculatedSummary = { initialRate, initialEMI, emiDeductionDay, disbursements: [...disbursements], emiChanges: [...emiChanges], partPayments: [...partPayments], rateChanges: [...rateChanges] };

            const disbursementMap = new Map();
            let totalDisbursed = 0;
            disbursements.forEach(d => {
                const key = `${d.date.getFullYear()}-${d.date.getMonth()}`;
                disbursementMap.set(key, (disbursementMap.get(key) || 0) + d.amount);
                totalDisbursed += d.amount;
            });
            const emiChangeMap = new Map();
            emiChanges.forEach(ec => { emiChangeMap.set(`${ec.date.getFullYear()}-${ec.date.getMonth()}`, ec.amount); });
            const partPaymentMap = new Map();
            partPayments.forEach(pp => {
                const key = `${pp.date.getFullYear()}-${pp.date.getMonth()}`;
                partPaymentMap.set(key, (partPaymentMap.get(key) || 0) + pp.amount);
            });
            const rateChangeMap = new Map();
            rateChanges.forEach(rc => { rateChangeMap.set(`${rc.date.getFullYear()}-${rc.date.getMonth()}`, rc.rate); });

            let balance = 0, currentRate = initialRate, currentEMI = initialEMI, month = 0;
            let totalInterestPaid = 0, totalPrincipalPaid = 0, totalPartPayments = 0;
            const schedule = [];
            let currentDate = new Date(startDate);
            currentDate.setDate(1);
            const today = new Date();
            let completedMonths = 0;

            while ((balance > 0.01 || month === 0 || disbursementMap.size > 0) && month < 600) {
                month++;
                const monthKey = `${currentDate.getFullYear()}-${currentDate.getMonth()}`;
                const disbursementThisMonth = disbursementMap.get(monthKey) || 0;
                if (disbursementThisMonth > 0) { balance += disbursementThisMonth; disbursementMap.delete(monthKey); }
                let emiChanged = false;
                if (emiChangeMap.has(monthKey)) { currentEMI = emiChangeMap.get(monthKey); emiChanged = true; }
                let rateChanged = false;
                if (rateChangeMap.has(monthKey)) { currentRate = rateChangeMap.get(monthKey); rateChanged = true; }
                const monthlyRate = currentRate / 12 / 100;
                let interestForMonth = balance * monthlyRate;
                const partPaymentThisMonth = partPaymentMap.get(monthKey) || 0;
                let emiPayment = 0, principalForMonth = 0;
                if (balance > 0) {
                    emiPayment = currentEMI;
                    if (balance + interestForMonth <= emiPayment + partPaymentThisMonth) emiPayment = Math.max(0, balance + interestForMonth - partPaymentThisMonth);
                    const totalPaymentThisMonth = emiPayment + partPaymentThisMonth;
                    principalForMonth = totalPaymentThisMonth - interestForMonth;
                    if (principalForMonth > balance) principalForMonth = balance;
                    balance = Math.max(0, balance - principalForMonth);
                    totalInterestPaid += interestForMonth;
                    totalPrincipalPaid += principalForMonth;
                    totalPartPayments += partPaymentThisMonth;
                }
                const emiDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), emiDeductionDay);
                if (emiDate <= today && balance >= 0) completedMonths = month;
                schedule.push({
                    month, date: new Date(currentDate), emiDay: emiDeductionDay, rate: currentRate, emi: currentEMI,
                    disbursement: disbursementThisMonth, principal: principalForMonth, interest: interestForMonth,
                    partPayment: partPaymentThisMonth, totalPayment: emiPayment + partPaymentThisMonth, balance,
                    rateChanged, emiChanged, hasPartPayment: partPaymentThisMonth > 0, hasDisbursement: disbursementThisMonth > 0
                });
                currentDate.setMonth(currentDate.getMonth() + 1);
                if (balance < 0.01 && disbursementMap.size === 0) break;
            }

            calculatedSchedule = schedule;
            const totalMonths = month;
            const remainingMonths = Math.max(0, totalMonths - completedMonths);

            // Get original bank term (in years, convert to months)
            const originalTermYears = parseInt(document.getElementById('originalTerm').value) || 0;
            const originalTermMonthsValue = originalTermYears * 12;

            // Calculate saved months vs original term
            const savedMonths = originalTermMonthsValue > 0 ? Math.max(0, originalTermMonthsValue - totalMonths) : 0;

            // Calculate interest saved (compare with what would have been paid over original term)
            const interestWithoutPartPayments = calculateInterestWithoutPartPayments(disbursements, initialRate, initialEMI, emiDeductionDay, emiChanges, rateChanges);
            const interestSaved = Math.max(0, interestWithoutPartPayments - totalInterestPaid);

            calculatedSummary.totalDisbursed = totalDisbursed;
            calculatedSummary.totalPrincipal = totalPrincipalPaid;
            calculatedSummary.totalInterest = totalInterestPaid;
            calculatedSummary.totalAmount = totalPrincipalPaid + totalInterestPaid;
            calculatedSummary.totalMonths = totalMonths;
            calculatedSummary.completedMonths = completedMonths;
            calculatedSummary.remainingMonths = remainingMonths;
            calculatedSummary.savedMonths = savedMonths;
            calculatedSummary.interestSaved = interestSaved;
            calculatedSummary.originalTermMonths = originalTermMonthsValue;

            document.getElementById('summaryDisbursed').textContent = formatCurrency(totalDisbursed);
            document.getElementById('totalPrincipal').textContent = formatCurrency(totalPrincipalPaid);
            document.getElementById('totalInterest').textContent = formatCurrency(totalInterestPaid);
            document.getElementById('totalAmount').textContent = formatCurrency(totalPrincipalPaid + totalInterestPaid);
            document.getElementById('interestSaved').textContent = formatCurrency(interestSaved);

            // Original term display
            document.getElementById('originalTermMonths').textContent = originalTermMonthsValue > 0 ? originalTermMonthsValue : '-';
            document.getElementById('originalTermYears').textContent = originalTermYears > 0 ? `${originalTermYears} years` : 'Not specified';

            // Actual term display
            document.getElementById('totalTermMonths').textContent = totalMonths;
            document.getElementById('totalTermYears').textContent = formatYearsMonths(totalMonths);
            document.getElementById('completedTermMonths').textContent = completedMonths;
            document.getElementById('completedTermYears').textContent = formatYearsMonths(completedMonths);
            document.getElementById('remainingTermMonths').textContent = remainingMonths;
            document.getElementById('remainingTermYears').textContent = formatYearsMonths(remainingMonths);
            document.getElementById('savedTermMonths').textContent = savedMonths;
            document.getElementById('savedTermYears').textContent = formatYearsMonths(savedMonths);

            const progressPercent = totalMonths > 0 ? Math.round((completedMonths / totalMonths) * 100) : 0;
            document.getElementById('progressPercent').textContent = progressPercent + '%';
            document.getElementById('progressFill').style.width = progressPercent + '%';
            document.getElementById('progressText').textContent = `${completedMonths} of ${totalMonths} months`;

            renderCharts(totalPrincipalPaid, totalInterestPaid, schedule, originalTermMonthsValue, totalMonths, savedMonths);

            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';
            schedule.forEach(row => {
                const tr = document.createElement('tr');
                if (row.hasDisbursement) tr.classList.add('disbursement-row');
                else if (row.emiChanged) tr.classList.add('emi-change-row');
                else if (row.rateChanged) tr.classList.add('rate-change-row');
                else if (row.hasPartPayment) tr.classList.add('part-payment-row');
                let eventIndicators = '';
                if (row.hasDisbursement) eventIndicators += `<span class="disbursement-badge">+${formatCurrency(row.disbursement)}</span>`;
                if (row.emiChanged) eventIndicators += `<span class="emi-badge">EMI: ${formatCurrency(row.emi)}</span>`;
                if (row.rateChanged) eventIndicators += `<span class="rate-badge">Rate: ${row.rate}%</span>`;
                if (row.hasPartPayment) eventIndicators += `<span class="part-payment-badge">Part Pay</span>`;
                tr.innerHTML = `
          <td>${row.month}</td>
          <td>${formatDate(row.date, row.emiDay)}<div class="event-indicator">${eventIndicators}</div></td>
          <td>${row.rate}%</td>
          <td>${formatCurrency(row.emi)}</td>
          <td>${row.disbursement > 0 ? formatCurrency(row.disbursement) : '-'}</td>
          <td class="amount-principal">${formatCurrency(row.principal)}</td>
          <td>${formatCurrency(row.interest)}</td>
          <td>${row.partPayment > 0 ? formatCurrency(row.partPayment) : '-'}</td>
          <td>${formatCurrency(row.totalPayment)}</td>
          <td class="${row.balance < 0.01 ? 'zero-remaining' : ''}">${formatCurrency(row.balance)}</td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('resultsSection').classList.add('visible');
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function calculateInterestWithoutPartPayments(disbursements, initialRate, initialEMI, emiDeductionDay, emiChanges, rateChanges) {
            const disbursementMap = new Map();
            disbursements.forEach(d => {
                const key = `${d.date.getFullYear()}-${d.date.getMonth()}`;
                disbursementMap.set(key, (disbursementMap.get(key) || 0) + d.amount);
            });
            const emiChangeMap = new Map();
            emiChanges.forEach(ec => { emiChangeMap.set(`${ec.date.getFullYear()}-${ec.date.getMonth()}`, ec.amount); });
            const rateChangeMap = new Map();
            rateChanges.forEach(rc => { rateChangeMap.set(`${rc.date.getFullYear()}-${rc.date.getMonth()}`, rc.rate); });
            let balance = 0, currentRate = initialRate, currentEMI = initialEMI, month = 0, totalInterest = 0;
            let currentDate = new Date(disbursements[0].date);
            currentDate.setDate(1);
            while ((balance > 0.01 || month === 0 || disbursementMap.size > 0) && month < 600) {
                month++;
                const monthKey = `${currentDate.getFullYear()}-${currentDate.getMonth()}`;
                const disbursementThisMonth = disbursementMap.get(monthKey) || 0;
                if (disbursementThisMonth > 0) { balance += disbursementThisMonth; disbursementMap.delete(monthKey); }
                if (emiChangeMap.has(monthKey)) currentEMI = emiChangeMap.get(monthKey);
                if (rateChangeMap.has(monthKey)) currentRate = rateChangeMap.get(monthKey);
                const monthlyRate = currentRate / 12 / 100;
                const interestForMonth = balance * monthlyRate;
                if (balance > 0) {
                    let emiPayment = currentEMI;
                    if (balance + interestForMonth <= emiPayment) emiPayment = balance + interestForMonth;
                    const principalForMonth = emiPayment - interestForMonth;
                    balance = Math.max(0, balance - principalForMonth);
                    totalInterest += interestForMonth;
                }
                currentDate.setMonth(currentDate.getMonth() + 1);
                if (balance < 0.01 && disbursementMap.size === 0) break;
            }
            return totalInterest;
        }

        function renderCharts(principal, interest, schedule, originalTermMonths, actualTermMonths, savedMonths) {
            if (pieChart) pieChart.destroy();
            if (lineChart) lineChart.destroy();

            // 1. Pie Chart - Payment Breakdown
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            const interestPercent = ((interest / (principal + interest)) * 100).toFixed(1);
            const principalPercent = ((principal / (principal + interest)) * 100).toFixed(1);
            pieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: [`Principal (${principalPercent}%)`, `Interest (${interestPercent}%)`],
                    datasets: [{
                        data: [principal, interest],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderColor: ['#059669', '#dc2626'],
                        borderWidth: 3,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '60%',
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#94a3b8', font: { size: 12 }, padding: 15 } },
                        tooltip: {
                            backgroundColor: '#1a2235',
                            callbacks: {
                                label: function (context) {
                                    return 'â‚¹' + context.raw.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                                }
                            }
                        }
                    }
                }
            });

            // 2. Line Chart - Balance Over Time (Year-wise)
            const lineCtx = document.getElementById('lineChart').getContext('2d');

            // Group data by year
            const yearlyData = {};
            schedule.forEach((s, i) => {
                const year = s.date.getFullYear();
                if (!yearlyData[year]) {
                    yearlyData[year] = { balance: s.balance, principalPaid: 0 };
                }
                yearlyData[year].balance = s.balance;
                yearlyData[year].principalPaid = schedule.slice(0, i + 1).reduce((sum, row) => sum + row.principal, 0);
            });

            const years = Object.keys(yearlyData);
            const balanceByYear = years.map(y => yearlyData[y].balance);
            const principalPaidByYear = years.map(y => yearlyData[y].principalPaid);

            lineChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Outstanding Balance',
                            data: balanceByYear,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 4,
                            pointBackgroundColor: '#ef4444'
                        },
                        {
                            label: 'Principal Paid',
                            data: principalPaidByYear,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 4,
                            pointBackgroundColor: '#10b981'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            ticks: { color: '#64748b' },
                            grid: { color: 'rgba(45, 58, 82, 0.3)' }
                        },
                        y: {
                            ticks: {
                                color: '#64748b',
                                callback: function (value) {
                                    if (value >= 10000000) return 'â‚¹' + (value / 10000000).toFixed(1) + 'Cr';
                                    return 'â‚¹' + (value / 100000).toFixed(1) + 'L';
                                }
                            },
                            grid: { color: 'rgba(45, 58, 82, 0.3)' }
                        }
                    },
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#94a3b8', font: { size: 12 }, padding: 15 } },
                        tooltip: {
                            backgroundColor: '#1a2235',
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': â‚¹' + context.raw.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                                }
                            }
                        }
                    }
                }
            });
        }

        function exportPDF() {
            if (calculatedSchedule.length === 0) { alert('Please calculate the loan first before exporting to PDF.'); return; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 15;
            let yPos = margin;
            const primaryColor = [245, 158, 11];
            const darkColor = [30, 41, 59];
            const grayColor = [100, 116, 139];
            const lightGray = [241, 245, 249];

            function addNewPage() { doc.addPage(); yPos = margin; }

            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, pageWidth, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('Loan Calculator Report', pageWidth / 2, 18, { align: 'center' });

            // Add user name if available
            const users = getAllUsers();
            const userName = currentUserId && users[currentUserId] ? users[currentUserId].name : 'Guest';
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`User: ${userName}`, pageWidth / 2, 28, { align: 'center' });

            doc.setFontSize(10);
            doc.text(`Generated on: ${new Date().toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' })}`, pageWidth / 2, 36, { align: 'center' });
            yPos = 55;

            doc.setTextColor(...darkColor);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Loan Summary', margin, yPos);
            yPos += 10;

            const summaryData = [
                { label: 'Total Disbursed', value: formatCurrencyPlain(calculatedSummary.totalDisbursed) },
                { label: 'Total Principal', value: formatCurrencyPlain(calculatedSummary.totalPrincipal) },
                { label: 'Total Interest', value: formatCurrencyPlain(calculatedSummary.totalInterest) },
                { label: 'Total Amount Paid', value: formatCurrencyPlain(calculatedSummary.totalAmount) },
                { label: 'Interest Saved', value: formatCurrencyPlain(calculatedSummary.interestSaved) },
                { label: 'Loan Tenure', value: `${calculatedSummary.totalMonths} months` }
            ];
            const boxWidth = (pageWidth - 2 * margin - 20) / 3;
            const boxHeight = 22;
            summaryData.forEach((item, index) => {
                const col = index % 3;
                const row = Math.floor(index / 3);
                const x = margin + col * (boxWidth + 10);
                const y = yPos + row * (boxHeight + 6);
                doc.setFillColor(...lightGray);
                doc.roundedRect(x, y, boxWidth, boxHeight, 3, 3, 'F');
                doc.setTextColor(...grayColor);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text(item.label.toUpperCase(), x + 5, y + 7);
                doc.setTextColor(...darkColor);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text(item.value, x + 5, y + 16);
            });
            yPos += Math.ceil(summaryData.length / 3) * (boxHeight + 6) + 10;

            doc.setTextColor(...darkColor);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Loan Term Analysis', margin, yPos);
            yPos += 8;
            const termData = [
                ['Original Bank Term', calculatedSummary.originalTermMonths > 0 ? `${calculatedSummary.originalTermMonths} months (${formatYearsMonths(calculatedSummary.originalTermMonths)})` : 'Not specified'],
                ['Actual Loan Term', `${calculatedSummary.totalMonths} months (${formatYearsMonths(calculatedSummary.totalMonths)})`],
                ['Completed Term', `${calculatedSummary.completedMonths} months (${formatYearsMonths(calculatedSummary.completedMonths)})`],
                ['Remaining Term', `${calculatedSummary.remainingMonths} months (${formatYearsMonths(calculatedSummary.remainingMonths)})`],
                ['Term Saved vs Original', `${calculatedSummary.savedMonths} months (${formatYearsMonths(calculatedSummary.savedMonths)})`]
            ];
            doc.autoTable({
                startY: yPos,
                body: termData,
                theme: 'plain',
                styles: { fontSize: 9, cellPadding: 4 },
                columnStyles: { 0: { fontStyle: 'bold', cellWidth: 60 } },
                margin: { left: margin, right: margin }
            });
            yPos = doc.lastAutoTable.finalY + 10;

            if (calculatedSummary.disbursements.length > 0) {
                doc.setTextColor(...darkColor);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('Disbursements', margin, yPos);
                yPos += 6;
                doc.autoTable({
                    startY: yPos,
                    head: [['#', 'Date', 'Amount (Rs.)']],
                    body: calculatedSummary.disbursements.map((d, i) => [i + 1, formatDateShort(d.date), formatCurrencyPlain(d.amount)]),
                    theme: 'striped',
                    headStyles: { fillColor: primaryColor, textColor: [255, 255, 255], fontStyle: 'bold', fontSize: 8 },
                    styles: { fontSize: 8, cellPadding: 2 },
                    columnStyles: { 0: { cellWidth: 10 }, 2: { halign: 'right' } },
                    margin: { left: margin, right: margin }
                });
                yPos = doc.lastAutoTable.finalY + 8;
            }

            if (calculatedSummary.partPayments.length > 0) {
                if (yPos > pageHeight - 50) addNewPage();
                doc.setTextColor(...darkColor);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('Part Payments', margin, yPos);
                yPos += 6;
                doc.autoTable({
                    startY: yPos,
                    head: [['#', 'Date', 'Amount (Rs.)']],
                    body: calculatedSummary.partPayments.map((p, i) => [i + 1, formatDateShort(p.date), formatCurrencyPlain(p.amount)]),
                    theme: 'striped',
                    headStyles: { fillColor: [16, 185, 129], textColor: [255, 255, 255], fontStyle: 'bold', fontSize: 8 },
                    styles: { fontSize: 8, cellPadding: 2 },
                    columnStyles: { 0: { cellWidth: 10 }, 2: { halign: 'right' } },
                    margin: { left: margin, right: margin }
                });
                yPos = doc.lastAutoTable.finalY + 8;
            }

            addNewPage();
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, pageWidth, 25, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('Amortization Schedule', pageWidth / 2, 16, { align: 'center' });
            yPos = 35;

            const tableData = calculatedSchedule.map(row => [
                row.month,
                formatDate(row.date, row.emiDay),
                row.rate + '%',
                formatCurrencyPlain(row.emi),
                row.disbursement > 0 ? formatCurrencyPlain(row.disbursement) : '-',
                formatCurrencyPlain(row.principal),
                formatCurrencyPlain(row.interest),
                row.partPayment > 0 ? formatCurrencyPlain(row.partPayment) : '-',
                formatCurrencyPlain(row.totalPayment),
                formatCurrencyPlain(row.balance)
            ]);
            doc.autoTable({
                startY: yPos,
                head: [['#', 'EMI Date', 'Rate', 'EMI', 'Disb.', 'Principal', 'Interest', 'Part Pay', 'Total', 'Balance']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: darkColor, textColor: [255, 255, 255], fontStyle: 'bold', fontSize: 6 },
                styles: { fontSize: 6, cellPadding: 2 },
                columnStyles: { 0: { cellWidth: 8 }, 1: { cellWidth: 20 }, 2: { cellWidth: 10 }, 3: { cellWidth: 16, halign: 'right' }, 4: { cellWidth: 16, halign: 'right' }, 5: { cellWidth: 16, halign: 'right' }, 6: { cellWidth: 16, halign: 'right' }, 7: { cellWidth: 16, halign: 'right' }, 8: { cellWidth: 16, halign: 'right' }, 9: { cellWidth: 18, halign: 'right' } },
                margin: { left: 5, right: 5 },
                didParseCell: function (data) {
                    if (data.section === 'body' && data.row.index === tableData.length - 1) {
                        data.cell.styles.textColor = [16, 185, 129];
                        data.cell.styles.fontStyle = 'bold';
                    }
                }
            });

            const pageCount = doc.internal.getNumberOfPages();
            const disclaimerText = 'DISCLAIMER: This report is for educational purposes only. Results are approximate and should not be considered as financial advice.';

            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);

                // Add disclaimer at bottom
                doc.setFontSize(7);
                doc.setTextColor(180, 140, 60);
                doc.text(disclaimerText, pageWidth / 2, pageHeight - 15, { align: 'center', maxWidth: pageWidth - 30 });

                // Add page number
                doc.setFontSize(8);
                doc.setTextColor(...grayColor);
                doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, pageHeight - 8, { align: 'center' });
            }
            doc.save(`Loan_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        document.addEventListener('keypress', (e) => { if (e.key === 'Enter' && e.target.tagName !== 'BUTTON') calculateLoan(); });
        document.addEventListener('DOMContentLoaded', () => { loadData(); });
    </script>
</body>

</html>
